# AccessGraph Helm Chart Values
# Production-ready defaults with security hardening

# Global settings
replicaCount: 1

image:
  api:
    repository: ghcr.io/jamesolaitan/accessgraph-api
    tag: "1.1.0"
    pullPolicy: IfNotPresent
  ui:
    repository: ghcr.io/jamesolaitan/accessgraph-ui
    tag: "1.1.0"
    pullPolicy: IfNotPresent
  opa:
    repository: openpolicyagent/opa
    tag: "0.60.0-rootless"
    pullPolicy: IfNotPresent

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Offline mode (default: true for security)
offline: true

# OPA configuration
opa:
  enabled: true
  port: 8181

# API configuration
api:
  port: 8080
  env:
    LOG_FORMAT: "json"
    READ_TIMEOUT: "15s"
    WRITE_TIMEOUT: "15s"
    IDLE_TIMEOUT: "60s"
    CORS_ALLOWED_ORIGINS: ""
    DEV: "false"
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
  
  # Resource limits
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  
  # Probes
  livenessProbe:
    httpGet:
      path: /healthz/live
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 3
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /healthz/ready
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3
  
  startupProbe:
    httpGet:
      path: /healthz
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 12

# UI configuration
ui:
  port: 80
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 101  # nginx user
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
  
  # Resource limits
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Service configuration
service:
  type: ClusterIP
  api:
    port: 8080
    targetPort: 8080
  ui:
    port: 80
    targetPort: 80
  opa:
    port: 8181
    targetPort: 8181

# Ingress configuration
ingress:
  enabled: false
  className: "nginx"
  annotations: {}
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: accessgraph.example.com
      paths:
        - path: /
          pathType: Prefix
          backend: ui
        - path: /query
          pathType: Prefix
          backend: api
        - path: /healthz
          pathType: Prefix
          backend: api
  tls: []
    # - secretName: accessgraph-tls
    #   hosts:
    #     - accessgraph.example.com

# Persistence configuration
persistence:
  enabled: false
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 1Gi
  # If disabled, use emptyDir
  emptyDir:
    sizeLimit: 1Gi

# Network policy
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
      - podSelector:
          matchLabels:
            app: accessgraph
  egress:
    # Allow DNS
    - to:
      - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
    # Allow inter-pod communication
    - to:
      - podSelector:
          matchLabels:
            app: accessgraph

# Pod security
podSecurityContext:
  fsGroup: 65534
  seccompProfile:
    type: RuntimeDefault

# Service account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}

